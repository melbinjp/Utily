const fs = require('fs');
const glob = require('glob');

// FontAwesome SVG paths - Complete set for this project
const iconSVGs = {
  'rocket': '<path d="M156.6 384.9L125.7 354c-8.5-8.5-11.5-20.8-7.7-32.2c3-8.9 7-20.5 11.8-33.8L24 288c-8.6 0-16.6-4.6-20.9-12.1s-4.2-16.7 .2-24.1l52.5-87.5c4.6-7.6 12.7-12.2 21.6-12.2h114.2c-.1-1.1-.1-2.2-.1-3.3c0-50.4 25.8-94.8 64-128.1V0c0-17.7 14.3-32 32-32s32 14.3 32 32V20.2c38.2 33.3 64 77.7 64 128.1c0 1.1 0 2.2-.1 3.3H498.7c8.9 0 16.9 4.6 21.6 12.2l52.5 87.5c4.4 7.4 4.7 16.6 .2 24.1s-12.3 12.1-20.9 12.1H447.5c4.8 13.3 8.8 24.9 11.8 33.8c3.8 11.4 .8 23.7-7.7 32.2L420.7 385c-6.9 6.9-17.2 8.9-26.2 5.2l-64.5-26.6c-4.4-1.8-9.7-1.8-14.1 0L251.4 390.2c-9 3.7-19.3 1.7-26.2-5.2L156.6 384.9z"/>',
  'arrow-right': '<path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/>',
  'external-link-alt': '<path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32H320zM80 32C35.8 32 0 67.8 0 112V432c0 44.2 35.8 80 80 80H400c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32V432c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H192c17.7 0 32-14.3 32-32s-14.3-32-32-32H80z"/>',
  'chevron-left': '<path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z"/>',
  'chevron-right': '<path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/>',
  'brain': '<path d="M184 0c30.9 0 56 25.1 56 56V456c0 30.9-25.1 56-56 56c-28.9 0-52.7-21.9-55.7-50.1c-5.2 1.4-10.7 2.1-16.3 2.1c-35.3 0-64-28.7-64-64c0-7.4 1.3-14.6 3.6-21.2C21.4 367.4 0 338.2 0 304c0-31.9 18.7-59.5 45.8-72.3C37.1 220.8 32 207 32 192c0-30.7 21.6-56.3 50.4-62.6C80.8 123.9 80 118 80 112c0-29.9 20.6-55.1 48.3-62.1C131.3 21.9 155.1 0 184 0zM328 0c28.9 0 52.7 21.9 55.7 50.1c5.2-1.4 10.7-2.1 16.3-2.1c35.3 0 64 28.7 64 64c0 7.4-1.3 14.6-3.6 21.2C490.6 144.6 512 173.8 512 208c0 31.9-18.7 59.5-45.8 72.3C474.9 291.2 480 305 480 320c0 30.7-21.6 56.3-50.4 62.6C431.2 388.1 432 394 432 400c0 29.9-20.6 55.1-48.3 62.1C380.7 490.1 356.9 512 328 512c-30.9 0-56-25.1-56-56V56c0-30.9 25.1-56 56-56z"/>',
  'moon': '<path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.6 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/>',
  'sun': '<path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"/>',
  'chevron-left': '<path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z"/>',
  'chevron-right': '<path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/>',
  'envelope': '<path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"/>',
  'plus': '<path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/>',
  'bug': '<path d="M256 0c53 0 96 43 96 96v3.6c0 15.7-12.7 28.4-28.4 28.4H188.4c-15.7 0-28.4-12.7-28.4-28.4V96c0-53 43-96 96-96zM41.4 105.4c12.5-12.5 32.8-12.5 45.3 0l64 64c.7 .7 1.3 1.4 1.9 2.1c14.2-7.3 30.4-11.4 47.5-11.4H312c17.1 0 33.2 4.1 47.5 11.4c.6-.7 1.2-1.4 1.9-2.1l64-64c12.5-12.5 32.8-12.5 45.3 0s12.5 32.8 0 45.3l-64 64c-.7 .7-1.4 1.3-2.1 1.9c6.2 12 10.1 25.3 11.1 39.5H480c17.7 0 32 14.3 32 32s-14.3 32-32 32H416c0 24-5.5 46.6-15.3 66.8c2.3 1.1 4.6 2.3 6.7 3.6l64 40c15.1 9.4 19.7 29.4 10.3 44.5s-29.4 19.7-44.5 10.3l-64-40c-2.1-1.3-4.2-2.6-6.2-4c-17.8 20.4-41.1 35.4-67.8 42.3c.9 7.6 1.4 15.2 1.4 23.1v5.5c0 17.7-14.3 32-32 32s-32-14.3-32-32v-5.5c0-7.9 .5-15.6 1.4-23.1c-26.7-6.9-50-21.9-67.8-42.3c-2.1 1.4-4.1 2.7-6.2 4l-64 40c-15.1 9.4-35.1 4.8-44.5-10.3s-4.8-35.1 10.3-44.5l64-40c2.1-1.3 4.4-2.5 6.7-3.6C101.5 302.6 96 280 96 256H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H96.3c1.1-14.1 5-27.5 11.1-39.5c-.7-.6-1.4-1.2-2.1-1.9l-64-64c-12.5-12.5-12.5-32.8 0-45.3z"/>',
  // Tools.json icons
  'flask': '<path d="M175 389.4c-9.8 16-15 34.3-15 53.1c-10 3.5-20.8 5.5-32 5.5c-53 0-96-43-96-96V64C14.3 64 0 49.7 0 32S14.3 0 32 0H96h64H288c17.7 0 32 14.3 32 32s-14.3 32-32 32V352c0 53-43 96-96 96c-11.2 0-22-2-32-5.5c0-18.8-5.2-37.1-15-53.1L144 334.6c-6-10.9-6-24.2 0-35.1L175 389.4zM24 0C10.7 0 0 10.7 0 24S10.7 48 24 48H88c13.3 0 24-10.7 24-24S101.3 0 88 0H24zM64 64v64c0 17.7 14.3 32 32 32H416c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32H96C78.3 32 64 46.3 64 64z"/>',
  'comments': '<path d="M88.2 309.1c9.8-18.3 6.8-40.8-7.5-55.8C59.4 230.9 48 186 48 139.7 48 62.8 114.6 0 256 0s208 62.8 208 139.7-66.6 139.7-208 139.7c-26.4 0-53.1-3.3-78.2-9.7L88.2 309.1zM304 139.7c0-15.3-14.3-27.7-32-27.7s-32 12.4-32 27.7s14.3 27.7 32 27.7s32-12.4 32-27.7zm96 0c0-15.3-14.3-27.7-32-27.7s-32 12.4-32 27.7s14.3 27.7 32 27.7s32-12.4 32-27.7z"/>',
  'microphone': '<path d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/>',
  'cube': '<path d="M234.5 5.7c13.9-5 29.1-5 43.1 0l192 68.6C495 83.4 512 107.5 512 134.6V377.4c0 27-17 51.2-42.5 60.3l-192 68.6c-13.9 5-29.1 5-43.1 0l-192-68.6C17 428.6 0 404.5 0 377.4V134.6c0-27 17-51.2 42.5-60.3l192-68.6zM256 66L82.3 128 256 190l173.7-62L256 66zm32 368.4l160-57.1v-188L288 246.6v187.8z"/>',
  'closed-captioning': '<path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM200 208c14.2 0 27 6.1 35.8 16c8.8 9.9 8.1 25.1-1.8 33.9s-25.1 8.1-33.9-1.8c-2.9-3.3-7.1-5.3-11.7-5.3c-8.8 0-16 7.2-16 16s7.2 16 16 16c4.6 0 8.9-2 11.7-5.3c8.8-9.9 24-10.6 33.9-1.8s10.6 24 1.8 33.9C227 318.9 214.2 325 200 325c-35.3 0-64-28.7-64-64s28.7-64 64-64zm144 0c14.2 0 27 6.1 35.8 16c8.8 9.9 8.1 25.1-1.8 33.9s-25.1 8.1-33.9-1.8c-2.9-3.3-7.1-5.3-11.7-5.3c-8.8 0-16 7.2-16 16s7.2 16 16 16c4.6 0 8.9-2 11.7-5.3c8.8-9.9 24-10.6 33.9-1.8s10.6 24 1.8 33.9C371 318.9 358.2 325 344 325c-35.3 0-64-28.7-64-64s28.7-64 64-64z"/>',
  'video': '<path d="M0 128C0 92.7 28.7 64 64 64H320c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128zM559.1 99.8c10.4 5.6 16.9 16.4 16.9 28.2V384c0 11.8-6.5 22.6-16.9 28.2s-23 5-32.9-1.6l-96-64L416 337.1V320 192 174.9l14.2-9.5 96-64c9.8-6.5 22.4-7.2 32.9-1.6z"/>',
  'image': '<path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6h96 32H424c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/>',
  'desktop': '<path d="M64 0C28.7 0 0 28.7 0 64V352c0 35.3 28.7 64 64 64H240l-10.7 32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32H352c17.7 0 32-14.3 32-32s-14.3-32-32-32H282.7L272 416H448c35.3 0 64-28.7 64-64V64c0-35.3-28.7-64-64-64H64zM512 64V288H0V64H512z"/>',
  'code-branch': '<path d="M80 104a24 24 0 1 0 0-48 24 24 0 1 0 0 48zm80-24c0 32.8-19.7 61-48 73.3V192c0 17.7 14.3 38.4 32 38.4H304c17.7 0 32-20.7 32-38.4V153.3C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3V192c0 53-43 96-96 96H208c-53 0-96-43-96-96V153.3C83.7 141 64 112.8 64 80c0-44.2 35.8-80 80-80s80 35.8 80 80zm208 24a24 24 0 1 0 0-48 24 24 0 1 0 0 48zM80 408a24 24 0 1 0 0-48 24 24 0 1 0 0 48zm0 80c44.2 0 80-35.8 80-80c0-32.8-19.7-61-48-73.3V272c0-17.7-14.3-32-32-32s-32 14.3-32 32v62.7C19.7 347 0 375.2 0 408c0 44.2 35.8 80 80 80z"/>',
  'star': '<path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3L288.1 439l128.3 69.3c10.8 5.8 24.1 4.8 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"/>',
  // Brand icons (different viewBox)
  'youtube': '<path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/>' 
};

// Auto-detect used icons from project files
function detectUsedIcons() {
  const files = glob.sync('**/*.{html,js,json}', { 
    ignore: ['node_modules/**', 'dist/**', 'scripts/**'] 
  });
  
  const iconRegex = /(?:fa-|icon.*?["'])([\w-]+)/g;
  const usedIcons = new Set();
  
  files.forEach(file => {
    const content = fs.readFileSync(file, 'utf8');
    let match;
    while ((match = iconRegex.exec(content)) !== null) {
      const iconName = match[1].replace('fa-', '');
      if (iconSVGs[iconName]) {
        usedIcons.add(iconName);
      }
    }
  });
  
  return Array.from(usedIcons);
}

// Generate SVG sprite
function generateSVGSprite(icons) {
  const symbols = icons.map(icon => {
    // YouTube uses different viewBox
    const viewBox = icon === 'youtube' ? '0 0 576 512' : '0 0 512 512';
    return `<symbol id="icon-${icon}" viewBox="${viewBox}">${iconSVGs[icon]}</symbol>`;
  }).join('\n  ');
  
  return `<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  ${symbols}
</svg>`;
}

// Generate CSS for SVG icons
function generateIconCSS(icons) {
  return `/* Auto-generated Icon System */
.icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  fill: currentColor;
  vertical-align: -0.125em;
}

${icons.map(icon => 
  `.icon-${icon} { /* ${icon} icon */ }`
).join('\n')}`;
}

// Main build function
function buildIcons() {
  const usedIcons = detectUsedIcons();
  console.log('🔍 Detected icons:', usedIcons);
  
  // Create output directory
  fs.mkdirSync('dist/assets/icons', { recursive: true });
  
  // Generate SVG sprite
  const sprite = generateSVGSprite(usedIcons);
  fs.writeFileSync('dist/assets/icons/sprite.svg', sprite);
  
  // Generate CSS
  const css = generateIconCSS(usedIcons);
  fs.writeFileSync('dist/assets/icons/icons.css', css);
  
  console.log('✅ Generated SVG sprite with', usedIcons.length, 'icons');
  console.log('📦 Files: sprite.svg, icons.css');
}

if (require.main === module) {
  buildIcons();
}

module.exports = { buildIcons };